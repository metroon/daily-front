// Colors
const colors = [
  "#ff0000",
  "#ff8800",
  "#ffd500",
  "#ddff00",
  "#15ff00",
  "#00ffaa",
  "#00eeff",
  "#0077ff",
  "#5100ff",
  "#aa00ff",
  "#ff00ff",
  "#880000",
  "#904d00",
  "#937b00",
  "#7e9100",
  "#0d9900",
  "#008e5f",
  "#007982",
  "#003673",
  "#1d005c",
  "#4a006e",
  "#6a006a",
];
let usedColors = [...colors];

function getRandomColor() {
  if (!usedColors.length) {
    usedColors = [...colors];
  }
  let randomIndex = Math.floor(Math.random() * usedColors.length);
  let randomColor = usedColors[randomIndex];
  usedColors = usedColors.filter((c) => c != randomColor);
  return randomColor;
}

function getAccentColor(color) {
  color = tinycolor(color);
  return color.isDark()
    ? color.lighten(15).toString()
    : color.darken(15).toString();
}

function pad(num) {
  return num.toString().padStart(2, "0");
}

class Member {
  constructor({ id, name, picture }) {
    this.id = id;
    this.name = name;
    this.picture = picture || "assets/images/race/helmet.png";
  }
}
const X = 150;
class Car {
  constructor(member, height, width) {
    this.x = Math.min(X, height);
    this.y = 0;
    this.speed = 0;
    this.color = getRandomColor();
    this.accentColor = getAccentColor(this.color);
    this.width = width;
    this.height = height;
    this.path = new Path2D();
    this.member = member;
    this.showText = false;
    this.img = new Image();
    if (member?.picture) {
      this.img.src = member.picture;
      this.img.onload = function () {
        ctx.drawImage(this, 10, 10, 100, 100);
      };
    }
  }

  reset() {
    this.x = Math.min(X, this.height * 1.75);
    this.speed = 0;
    this.showText = false;
  }

  draw(ctx) {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.scale(0.175, 0.175);

    ctx.save();
    ctx.fillStyle = "#E6E9ED";
    this.path = new Path2D(
      "M479.991 149.993C474.1 149.993 469.335 145.212 469.335 139.321V117.995C469.335 112.104 474.101 107.323 479.991 107.323C485.881 107.323 490.647 112.104 490.647 117.995V139.321C490.647 145.212 485.882 149.993 479.991 149.993Z"
    );
    this.path.addPath(
      new Path2D(
        "M501.334 160.665H458.647C452.772 160.665 447.991 155.884 447.991 149.993C447.991 144.102 452.772 139.321 458.647 139.321H501.334C507.209 139.321 511.99 144.102 511.99 149.993C511.99 155.884 507.209 160.665 501.334 160.665Z"
      )
    );
    this.path.addPath(
      new Path2D(
        "M309.338 85.995C303.432 85.995 298.65 81.214 298.65 75.323V64.667C298.65 58.776 303.431 53.995 309.338 53.995C315.213 53.995 319.993 58.776 319.993 64.667V75.323C319.993 81.214 315.213 85.995 309.338 85.995Z"
      )
    );
    this.path.addPath(
      new Path2D(
        "M234.66 43.324C228.769 43.324 223.996 38.558 223.996 32.668V21.996C223.996 16.105 228.769 11.324 234.66 11.324C240.55 11.324 245.331 16.105 245.331 21.996V32.668C245.331 38.558 240.55 43.324 234.66 43.324Z"
      )
    );
    this.path.addPath(
      new Path2D(
        "M33.343 117.995H10.664C4.773 117.995 0 113.214 0 107.323V11.325C0 5.434 4.773 0.669006 10.664 0.669006H95.998C101.889 0.669006 106.662 5.435 106.662 11.325V32.669C106.662 35.169 105.779 37.606 104.17 39.512L41.515 114.183C39.491 116.604 36.499 117.995 33.343 117.995Z"
      )
    );
    ctx.fill(this.path);
    ctx.restore();

    ctx.save();
    ctx.fillStyle = this.accentColor;
    this.path = new Path2D(
      "M490.147 84.183C480.241 78.245 466.772 73.542 450.085 70.199C422.694 64.73 395.789 64.668 394.648 64.668C388.774 64.668 383.993 69.434 383.993 75.324V117.995C383.993 123.886 388.774 128.667 394.648 128.667H501.334C507.209 128.667 511.99 123.886 511.99 117.995C511.99 108.542 508.209 95.011 490.147 84.183Z"
    );
    this.path.addPath(
      new Path2D(
        "M394.648 64.667H255.995V32.668C255.995 26.777 251.222 21.996 245.331 21.996C135.888 21.996 83.061 67.495 80.866 69.433C79.077 71.027 77.866 73.167 77.436 75.511L64.17 148.071C63.6 151.196 64.443 154.399 66.475 156.821C68.498 159.259 71.498 160.665 74.663 160.665H309.338C311.635 160.665 313.869 159.915 315.729 158.524L358.4 126.526C363.103 122.995 364.056 116.307 360.525 111.588C357.869 108.041 353.416 106.635 349.369 107.65L394.648 85.995C400.554 85.995 405.336 81.214 405.336 75.323C405.336 69.432 400.555 64.667 394.648 64.667Z"
      )
    );
    ctx.fill(this.path);
    ctx.restore();

    ctx.save();
    ctx.fillStyle = this.color;
    this.path = new Path2D(
      "M255.995 64.667V32.668C255.995 26.777 251.222 21.996 245.331 21.996C135.888 21.996 83.061 67.495 80.866 69.433C79.077 71.027 77.866 73.167 77.436 75.511L64.17 148.071C63.6 151.196 64.443 154.399 66.475 156.821C68.498 159.259 77.491 81.339 80.655 81.339L255.995 64.667Z"
    );
    this.path.addPath(
      new Path2D("M293.342 64.665H282.655V160.665H293.342V64.665Z")
    );
    this.path.addPath(
      new Path2D(
        "M234.66 128.667H170.661C164.77 128.667 159.997 123.886 159.997 117.995C159.997 112.104 164.77 107.323 170.661 107.323H234.66C240.55 107.323 245.331 112.104 245.331 117.995C245.331 123.886 240.55 128.667 234.66 128.667Z"
      )
    );
    ctx.fill(this.path);
    ctx.restore();

    ctx.save();
    ctx.fillStyle = "black";
    this.path = new Path2D(
      "M394.484 65C364.984 65 341 88.9986 341 118.501C341 148 364.983 172 394.484 172C424.001 172 448 148 448 118.501C448 88.9996 424.001 65 394.484 65Z"
    );
    this.path.addPath(
      new Path2D(
        "M74.4845 65C44.9843 65 21 88.9986 21 118.501C21 148 44.9833 172 74.4845 172C104.001 172 128 148 128 118.501C128 88.9996 104.001 65 74.4845 65Z"
      )
    );
    ctx.fill(this.path);
    ctx.restore();

    ctx.save();
    ctx.fillStyle = "#F5F7FA";
    this.path = new Path2D(
      "M399.1 122.954C396.557 125.682 392.433 125.682 389.9 122.954C387.367 120.215 387.367 115.785 389.9 113.046C392.433 110.318 396.557 110.318 399.1 113.046C401.633 115.785 401.633 120.215 399.1 122.954Z"
    );
    this.path.addPath(
      new Path2D(
        "M79.1 122.954C76.5569 125.682 72.4333 125.682 69.9 122.954C67.3667 120.215 67.3667 115.785 69.9 113.046C72.4333 110.318 76.5569 110.318 79.1 113.046C81.6333 115.785 81.6333 120.215 79.1 122.954Z"
      )
    );
    ctx.fill(this.path);
    ctx.restore();

    ctx.save();
    ctx.fillStyle = "#434A54";
    this.path = new Path2D(
      "M394.5 83.9305C404.044 83.9305 412.69 87.7967 418.942 94.0575C425.195 100.31 429.07 108.956 429.07 118.5C429.07 128.044 425.203 136.69 418.942 142.942C412.69 149.195 404.044 153.07 394.5 153.07C384.956 153.07 376.31 149.203 370.058 142.942C363.805 136.69 359.931 128.044 359.931 118.5C359.931 108.956 363.797 100.31 370.058 94.0575C376.31 87.8054 384.956 83.9305 394.5 83.9305ZM394.5 65C409.277 65 422.652 70.9909 432.326 80.6738C442.009 90.3568 448 103.732 448 118.5C448 133.277 442.009 146.652 432.326 156.326C422.643 166.009 409.268 172 394.5 172C379.723 172 366.348 166.009 356.674 156.326C346.991 146.652 341 133.277 341 118.5C341 103.723 346.991 90.3481 356.674 80.6738C366.348 70.9909 379.723 65 394.5 65ZM422.391 90.6093C415.25 83.469 405.393 79.0542 394.5 79.0542C383.607 79.0542 373.75 83.469 366.609 90.6093C359.469 97.7496 355.054 107.607 355.054 118.5C355.054 129.393 359.469 139.25 366.609 146.391C373.75 153.531 383.607 157.946 394.5 157.946C405.393 157.946 415.25 153.531 422.391 146.391C429.531 139.25 433.946 129.393 433.946 118.5C433.946 107.607 429.531 97.7496 422.391 90.6093ZM397.992 114.434C397.104 113.545 395.876 112.997 394.5 112.997C393.133 112.997 391.896 113.545 391.008 114.434L391 114.442C390.111 115.33 389.563 116.558 389.563 117.934C389.563 119.301 390.111 120.538 391 121.426L391.008 121.434C391.896 122.323 393.124 122.871 394.5 122.871C395.867 122.871 397.104 122.323 397.992 121.434L398 121.426C398.889 120.538 399.437 119.301 399.437 117.934C399.429 116.558 398.88 115.33 397.992 114.434ZM397.652 109.226C398.932 109.697 400.09 110.437 401.039 111.386C401.362 111.708 401.666 112.056 401.936 112.431L402.023 112.405L420.327 107.502C418.908 104.167 416.861 101.163 414.336 98.6465C409.956 94.2665 404.131 91.3233 397.643 90.6006V108.991C397.661 109.07 397.661 109.148 397.652 109.226ZM403.73 118.665C403.608 120.172 403.129 121.583 402.363 122.81C402.407 122.863 402.441 122.924 402.476 122.984L412.986 139.642C413.457 139.233 413.909 138.806 414.354 138.362C419.43 133.286 422.574 126.259 422.574 118.509C422.574 116.88 422.434 115.287 422.164 113.728L403.73 118.665ZM397.226 126.781C396.363 127.051 395.449 127.19 394.5 127.19C393.647 127.19 392.819 127.077 392.027 126.859L381.769 143.535C385.592 145.485 389.92 146.582 394.5 146.582C399.254 146.582 403.73 145.398 407.657 143.317L397.226 126.781ZM386.776 123.028C385.975 121.826 385.453 120.424 385.296 118.927H385.287L366.923 113.18C366.592 114.904 366.418 116.68 366.418 118.5C366.418 126.25 369.561 133.277 374.638 138.354C375.186 138.902 375.761 139.433 376.362 139.938L386.637 123.228C386.689 123.167 386.733 123.098 386.776 123.028ZM386.907 112.648C387.22 112.204 387.569 111.778 387.961 111.395C388.875 110.489 389.972 109.766 391.191 109.296C391.182 109.2 391.174 109.096 391.174 109V90.6267C384.747 91.3843 378.983 94.3101 374.646 98.6552C372.252 101.05 370.284 103.88 368.873 107.015L386.907 112.648Z"
    );
    this.path.addPath(
      new Path2D(
        "M74.5 83.9305C84.0436 83.9305 92.6904 87.7967 98.9425 94.0575C105.195 100.31 109.07 108.956 109.07 118.5C109.07 128.044 105.203 136.69 98.9425 142.942C92.6904 149.195 84.0436 153.07 74.5 153.07C64.9564 153.07 56.3097 149.203 50.0575 142.942C43.8054 136.69 39.9305 128.044 39.9305 118.5C39.9305 108.956 43.7967 100.31 50.0575 94.0575C56.3097 87.8054 64.9564 83.9305 74.5 83.9305ZM74.5 65C89.2769 65 102.652 70.9909 112.326 80.6738C122.009 90.3568 128 103.732 128 118.5C128 133.277 122.009 146.652 112.326 156.326C102.643 166.009 89.2682 172 74.5 172C59.7231 172 46.3481 166.009 36.6738 156.326C26.9909 146.652 21 133.277 21 118.5C21 103.723 26.9909 90.3481 36.6738 80.6738C46.3481 70.9909 59.7231 65 74.5 65ZM102.391 90.6093C95.2504 83.469 85.3933 79.0542 74.5 79.0542C63.6067 79.0542 53.7496 83.469 46.6093 90.6093C39.469 97.7496 35.0542 107.607 35.0542 118.5C35.0542 129.393 39.469 139.25 46.6093 146.391C53.7496 153.531 63.6067 157.946 74.5 157.946C85.3933 157.946 95.2504 153.531 102.391 146.391C109.531 139.25 113.946 129.393 113.946 118.5C113.946 107.607 109.531 97.7496 102.391 90.6093ZM77.9918 114.434C77.1036 113.545 75.8758 112.997 74.5 112.997C73.1329 112.997 71.8964 113.545 71.0082 114.434L70.9995 114.442C70.1113 115.33 69.5627 116.558 69.5627 117.934C69.5627 119.301 70.1113 120.538 70.9995 121.426L71.0082 121.434C71.8964 122.323 73.1242 122.871 74.5 122.871C75.8671 122.871 77.1036 122.323 77.9918 121.434L78.0005 121.426C78.8887 120.538 79.4373 119.301 79.4373 117.934C79.4286 116.558 78.88 115.33 77.9918 114.434ZM77.6522 109.226C78.9322 109.697 80.0903 110.437 81.0395 111.386C81.3617 111.708 81.6664 112.056 81.9364 112.431L82.0234 112.405L100.327 107.502C98.9076 104.167 96.8613 101.163 94.3361 98.6465C89.9561 94.2665 84.1307 91.3233 77.6435 90.6006V108.991C77.6609 109.07 77.6609 109.148 77.6522 109.226ZM83.7301 118.665C83.6082 120.172 83.1293 121.583 82.363 122.81C82.4066 122.863 82.4414 122.924 82.4762 122.984L92.9864 139.642C93.4566 139.233 93.9094 138.806 94.3535 138.362C99.4301 133.286 102.574 126.259 102.574 118.509C102.574 116.88 102.434 115.287 102.164 113.728L83.7301 118.665ZM77.2255 126.781C76.3634 127.051 75.4491 127.19 74.5 127.19C73.6466 127.19 72.8194 127.077 72.027 126.859L61.7694 143.535C65.592 145.485 69.9198 146.582 74.5 146.582C79.2544 146.582 83.7301 145.398 87.6573 143.317L77.2255 126.781ZM66.7763 123.028C65.9752 121.826 65.4527 120.424 65.296 118.927H65.2873L46.9228 113.18C46.5919 114.904 46.4177 116.68 46.4177 118.5C46.4177 126.25 49.5612 133.277 54.6378 138.354C55.1864 138.902 55.7611 139.433 56.3619 139.938L66.637 123.228C66.6892 123.167 66.7327 123.098 66.7763 123.028ZM66.9069 112.648C67.2204 112.204 67.5687 111.778 67.9605 111.395C68.8748 110.489 69.972 109.766 71.1911 109.296C71.1824 109.2 71.1737 109.096 71.1737 109V90.6267C64.7474 91.3843 58.9829 94.3101 54.6465 98.6552C52.2519 101.05 50.2839 103.88 48.8733 107.015L66.9069 112.648Z"
      )
    );
    ctx.fill(this.path);
    ctx.restore();
    ctx.restore();

    if (this.showText) {
      ctx.save();
      ctx.fillStyle = "#ffffff";
      ctx.font = "24px Fugaz One";

      let id = `${this.member.id}`.padStart(2, "0");
      let name = this.member.name.slice(0, 3).toUpperCase();
      ctx.fillText(
        "#" + id,
        this.x - this.width - 120,
        this.y + this.height / 2 
      );
      ctx.fillText(
        name,
        this.x - this.width - 50,
        this.y + this.height / 2 
      );
      ctx.restore();
    }

    if (this.member.picture) {
      ctx.save();
      const xx = this.x - (this.height * .75);
      const yy = this.y + this.height / 4;
      const circleX = xx;
      const circleY = yy;
      const circleRadius = this.height / 2;
      const imageWidth = circleRadius * 2;
      const imageHeight = circleRadius * 2;
      const imageX = circleX - imageWidth / 2;
      const imageY = circleY - imageHeight / 2;
      ctx.beginPath();
      ctx.arc(circleX, circleY, circleRadius, 0, 2 * Math.PI);
      ctx.strokeStyle = "white";
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.closePath();
      ctx.beginPath();
      ctx.arc(circleX, circleY, circleRadius - 2, 0, 2 * Math.PI);
      ctx.clip();
      ctx.drawImage(this.img, imageX, imageY, imageWidth, imageHeight);
      ctx.restore();
    }
  }

  move() {
    this.x += this.speed;
  }
}
